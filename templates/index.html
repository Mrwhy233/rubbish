<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>ğŸŒ æ™ºèƒ½åˆ†é¡µç½‘é¡µçˆ¬è™«</title>
<style>
/* ====== é€šç”¨æ ·å¼ ====== */
* { box-sizing: border-box; }
body {
  margin: 0;
  display: flex;
  height: 100vh;
  font-family: "Segoe UI", "PingFang SC", sans-serif;
  background: #f4f5f9;
  color: #333;
}

/* ====== å·¦ä¾§å¯¼èˆªæ  ====== */
#sidebar {
  width: 290px;
  background: #1e293b;
  color: #e2e8f0;
  display: flex;
  flex-direction: column;
  padding: 15px;
  overflow-y: auto;
  border-right: 1px solid #334155;
}
#sidebar h3 {
  margin-top: 0;
  padding-bottom: 8px;
  border-bottom: 1px solid #334155;
}
.search-box {
  width: 100%;
  padding: 8px 10px;
  border-radius: 6px;
  border: none;
  outline: none;
  margin: 10px 0 15px;
  background: #334155;
  color: #e2e8f0;
}
.search-box::placeholder { color: #94a3b8; }

.history-item {
  background: #2b364a;
  padding: 10px;
  border-radius: 6px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: background 0.2s;
}
.history-item:hover { background: #3b475e; }
.history-item b { display: block; color: #fff; }
.history-item small { color: #93c5fd; }
button.small {
  background: none;
  border: none;
  color: #9ca3af;
  font-size: 12px;
  cursor: pointer;
  margin-right: 5px;
}
button.small:hover { color: #fff; }

/* ====== ä¸»åŒº ====== */
#main {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 0;
  overflow: hidden;
}

/* é¡¶éƒ¨æ  */
#main header {
  background: #1d4ed8;
  color: white;
  padding: 10px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
#main header h2 {
  margin: 0;
  font-size: 20px;
}
#url {
  flex: 1;
  padding: 8px 10px;
  border-radius: 6px;
  outline: none;
  border: none;
  font-size: 14px;
}
#start {
  background: #10b981;
  border: none;
  color: white;
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 14px;
  margin-left: 10px;
  cursor: pointer;
  transition: background 0.2s;
}
#start:hover { background: #059669; }

/* ä¸»å†…å®¹å®¹å™¨ */
#main-content {
  flex: 1;
  overflow-y: auto;
  padding: 20px 30px;
}

/* å¡ç‰‡å¸ƒå±€ */
.card {
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  padding: 20px;
  margin-bottom: 20px;
}
.card h3 {
  margin-top: 0;
  border-bottom: 1px solid #e2e8f0;
  padding-bottom: 8px;
}

/* æ—¥å¿—æ ·å¼ */
#logs {
  background: #0f172a;
  color: #38bdf8;
  font-family: Consolas, monospace;
  font-size: 13px;
  padding: 10px;
  border-radius: 6px;
  height: 200px;
  overflow-y: auto;
  white-space: pre-wrap;
}

/* åˆ†é¡µæ¡ */
.pagination {
  margin-top: 10px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.pagination button {
  background: #2563eb;
  border: none;
  border-radius: 6px;
  color: white;
  padding: 5px 10px;
  cursor: pointer;
  transition: 0.15s;
}
.pagination button:hover { background: #1e40af; }
.pagination button:disabled {
  background: #9ca3af;
  cursor: not-allowed;
}
.pagination span { font-size: 14px; color: #555; }

/* è¡¨æ ¼æ ·å¼ */
table {
  border-collapse: collapse;
  width: 100%;
  font-size: 14px;
  margin-top: 10px;
}
th, td {
  border: 1px solid #e2e8f0;
  padding: 6px 8px;
  text-align: left;
}
th {
  background: #eff6ff;
  color: #1d4ed8;
}
button.export {
  background: #2563eb;
  border: none;
  color: white;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  margin-top: 5px;
}
button.export:hover { background: #1e40af; }

/* æ–‡æœ¬å†…å®¹ */
p { text-indent: 2em; line-height: 1.7; }

hr {
  border: none;
  border-top: 1px solid #e5e7eb;
  margin: 15px 0;
}
</style>
</head>

<body>
  <!-- å·¦æ  -->
  <div id="sidebar">
    <h3>ğŸ“œ å†å²è®°å½•</h3>
    <input id="search" class="search-box" type="text" placeholder="ğŸ” æœç´¢æ ‡é¢˜æˆ–ç½‘å€...">
    <div id="history-list">åŠ è½½ä¸­...</div>
  </div>

  <!-- å³æ  -->
  <div id="main">
    <header>
      <h2>ğŸŒ æ™ºèƒ½åˆ†é¡µçˆ¬è™«ï¼ˆå«è¡¨æ ¼åˆ†é¡µï¼‰</h2>
      <div style="display:flex;align-items:center;gap:10px;">
        <input id="url" type="text" placeholder="è¯·è¾“å…¥ç½‘å€...">
        <button id="start">å¼€å§‹çˆ¬å–</button>
      </div>
    </header>

    <div id="main-content">
      <div class="card">
        <h3>ğŸ§  å®æ—¶æ—¥å¿—</h3>
        <div id="logs">ç­‰å¾…å¼€å§‹çˆ¬å–...</div>
      </div>

      <div class="card">
        <h3>ğŸ“° æ­£æ–‡åˆ†é¡µ</h3>
        <h4 id="title"></h4>
        <div id="content"></div>
        <div class="pagination" id="text-pagination" style="display:none;">
          <button id="prev-text">ä¸Šä¸€é¡µ</button>
          <span id="text-pageinfo"></span>
          <button id="next-text">ä¸‹ä¸€é¡µ</button>
        </div>
      </div>

      <div class="card">
        <h3 id="link-title" style="display:none;">ğŸ”— é“¾æ¥åˆ†é¡µå±•ç¤º</h3>
        <div id="links"></div>
        <div class="pagination" id="link-pagination" style="display:none;">
          <button id="prev-link">ä¸Šä¸€é¡µ</button>
          <span id="link-pageinfo"></span>
          <button id="next-link">ä¸‹ä¸€é¡µ</button>
        </div>
      </div>

      <div class="card">
        <h3 id="table-title" style="display:none;">ğŸ“Š è¡¨æ ¼åˆ†é¡µå±•ç¤º</h3>
        <div id="tables"></div>
        <div class="pagination" id="table-pagination" style="display:none;">
          <button id="prev-table">ä¸Šä¸€é¡µ</button>
          <span id="table-pageinfo"></span>
          <button id="next-table">ä¸‹ä¸€é¡µ</button>
        </div>
      </div>
    </div>
  </div>

<script>
// ===============================================
// ä¸€ã€åˆ†é¡µæ˜¾ç¤ºé€»è¾‘ï¼ˆæ–‡å­—ã€é“¾æ¥ï¼‰
// ===============================================
let paragraphs = [];
let allLinks = [];
let allTables = [];

let currentTextPage = 1;
const textPerPage = 10;
let currentLinkPage = 1;
const linksPerPage = 10;

let currentTablePage = 1;
const tablesPerPage = 1;  // æ¯é¡µæ˜¾ç¤º1ä¸ªè¡¨æ ¼ï¼Œå¯æ”¹ä¸º2/3

function showTextPage(page) {
    const start = (page - 1) * textPerPage;
    const list = paragraphs.slice(start, start + textPerPage);
    document.getElementById('content').innerHTML = list.map(p => `<p>${p}</p>`).join('');
    document.getElementById('text-pageinfo').innerText = `ç¬¬ ${page} / ${Math.ceil(paragraphs.length / textPerPage)} é¡µ`;
    document.getElementById('prev-text').disabled = page <= 1;
    document.getElementById('next-text').disabled = start + textPerPage >= paragraphs.length;
}
function showLinkPage(page) {
    const start = (page - 1) * linksPerPage;
    const links = allLinks.slice(start, start + linksPerPage).filter(l => l && l.startsWith('http'));
    document.getElementById('links').innerHTML = links.length > 0
      ? links.map(l => `<a href="${l}" target="_blank">${l}</a>`).join('<br>')
      : "<p>æ— æ›´å¤šé“¾æ¥ã€‚</p>";
    document.getElementById('link-pageinfo').innerText = `ç¬¬ ${page} / ${Math.ceil(allLinks.length / linksPerPage)} é¡µ`;
    document.getElementById('prev-link').disabled = page <= 1;
    document.getElementById('next-link').disabled = start + linksPerPage >= allLinks.length;
}
document.getElementById('prev-text').onclick = () => { if(currentTextPage>1){currentTextPage--;showTextPage(currentTextPage);} };
document.getElementById('next-text').onclick = () => { if(currentTextPage*textPerPage<paragraphs.length){currentTextPage++;showTextPage(currentTextPage);} };
document.getElementById('prev-link').onclick = () => { if(currentLinkPage>1){currentLinkPage--;showLinkPage(currentLinkPage);} };
document.getElementById('next-link').onclick = () => { if(currentLinkPage*linksPerPage<allLinks.length){currentLinkPage++;showLinkPage(currentLinkPage);} };

// ===============================================
// äºŒã€è¡¨æ ¼åˆ†é¡µé€»è¾‘
// ===============================================
function showTablePage(page, indexInHistory=null) {
    const start = (page - 1) * tablesPerPage;
    const list = allTables.slice(start, start + tablesPerPage);

    const div = document.getElementById("tables");
    if (!list.length) {
        div.innerHTML = "<p>æ²¡æœ‰è¡¨æ ¼æ•°æ®</p>";
        document.getElementById("table-pagination").style.display = "none";
        return;
    }

    div.innerHTML = list.map((t, i) => {
        let idxDisplay = start + i + 1;
        let html = `<h4 class='table-title'>è¡¨æ ¼ ${idxDisplay}ï¼š</h4><table>`;
        if (t.headers && t.headers.length > 0) {
            html += `<tr>${t.headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
        }
        t.rows.forEach(row => {
            html += `<tr>${row.map(c => `<td>${c}</td>`).join('')}</tr>`;
        });
        html += `</table>`;
        if (indexInHistory !== null) {
            html += `<button class="small" onclick="downloadTableCSV(${indexInHistory}, ${idxDisplay-1})">ğŸ’¾ å¯¼å‡ºè¡¨æ ¼ ${idxDisplay}</button>`;
        }
        return html;
    }).join("<hr>");

    document.getElementById("table-title").style.display = "block";
    document.getElementById("table-pagination").style.display = "flex";
    document.getElementById("table-pageinfo").innerText = `ç¬¬ ${page} / ${Math.ceil(allTables.length / tablesPerPage)} é¡µ`;
    document.getElementById("prev-table").disabled = page <= 1;
    document.getElementById("next-table").disabled = start + tablesPerPage >= allTables.length;
}
document.getElementById('prev-table').onclick = () => { if(currentTablePage>1){currentTablePage--;showTablePage(currentTablePage);} };
document.getElementById('next-table').onclick = () => { if(currentTablePage*tablesPerPage<allTables.length){currentTablePage++;showTablePage(currentTablePage);} };

// ===============================================
// ä¸‰ã€æ ¸å¿ƒçˆ¬å–é€»è¾‘
// ===============================================
function startCrawl(url = null) {
    if (!url) url = document.getElementById("url").value.trim();
    if (!url) return alert("è¯·è¾“å…¥ URLï¼");

    document.getElementById("logs").innerText = "> å·²å¯åŠ¨çˆ¬å–ä»»åŠ¡...\n";
    document.getElementById("content").innerHTML = "";
    document.getElementById("tables").innerHTML = "";
    document.getElementById("title").innerText = "";
    document.getElementById("link-title").style.display = "none";
    document.getElementById("table-title").style.display = "none";
    document.getElementById("text-pagination").style.display = "none";
    document.getElementById("link-pagination").style.display = "none";
    document.getElementById("table-pagination").style.display = "none";

    paragraphs = []; allLinks = []; allTables = [];
    currentTextPage = 1; currentLinkPage = 1; currentTablePage = 1;

    fetch("/stream", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({url})
    }).then(r => {
        const reader = r.body.getReader();
        const decoder = new TextDecoder();
        (function read() {
            reader.read().then(({done, value}) => {
                if (done) {
                    document.getElementById("logs").innerText += "\nâœ… çˆ¬å–å®Œæˆã€‚\n";
                    loadHistory();
                    return;
                }
                const txt = decoder.decode(value);
                txt.split("\n\n").forEach(line => {
                    if (line.startsWith("data: ")) {
                        try {
                            const msg = JSON.parse(line.replace("data: ", ""));
                            if (msg.log) document.getElementById("logs").innerText += msg.log + "\n";
                            if (msg.result) {
                                document.getElementById("title").innerText = msg.result.title;
                                paragraphs = msg.result.paragraphs || [];
                                allLinks = msg.result.links || [];
                                allTables = msg.result.tables || [];

                                if (paragraphs.length > 0) {
                                    document.getElementById("text-pagination").style.display = "flex";
                                    showTextPage(1);
                                }
                                if (allLinks.length > 0) {
                                    document.getElementById("link-title").style.display = "block";
                                    document.getElementById("link-pagination").style.display = "flex";
                                    showLinkPage(1);
                                }
                                if (allTables.length > 0) {
                                    showTablePage(1); // è¡¨æ ¼åˆ†é¡µæ˜¾ç¤º
                                }
                            }
                        } catch(e){}
                    }
                });
                read();
            });
        })();
    });
}
document.getElementById('start').onclick = () => startCrawl();

// ===============================================
// å››ã€å†å²é€»è¾‘
// ===============================================
async function loadHistory(query="") {
    const res = await fetch("/history");
    const data = await res.json();
    const list = document.getElementById("history-list");
    const filtered = query
        ? data.filter(d => (d.title && d.title.includes(query)) || d.url.includes(query))
        : data;
    if (filtered.length === 0) {
        list.innerHTML = "<p>æš‚æ— å†å²è®°å½•</p>";
        return;
    }
    list.innerHTML = filtered.map((item, idx) => `
        <div class="history-item" onclick="loadHistoryItem(${idx})">
            <b>${item.title || 'æ— æ ‡é¢˜'}</b><br>
            <small>${item.time}</small><br>
            <small style="color:#49f">${item.url}</small><br>
            <button class="small" onclick="event.stopPropagation();startCrawl('${item.url}')">ğŸ” é‡æ–°çˆ¬å–</button>
            <button class="small" onclick="event.stopPropagation();deleteHistory(${idx})">âŒ åˆ é™¤</button>
            <button class="small" onclick="event.stopPropagation();downloadHistory(${idx})">ğŸ’¾ å¯¼å‡º</button>
        </div>`).join('');
}
async function loadHistoryItem(idx) {
    const res = await fetch(`/history/${idx}`);
    const r = await res.json();
    document.getElementById("title").innerText = r.title;
    paragraphs = r.paragraphs || [];
    allLinks = r.links || [];
    allTables = r.tables || [];
    if (paragraphs.length > 0) {
        document.getElementById("text-pagination").style.display = "flex";
        showTextPage(1);
    }
    if (allLinks.length > 0) {
        document.getElementById("link-title").style.display = "block";
        document.getElementById("link-pagination").style.display = "flex";
        showLinkPage(1);
    }
    if (allTables.length > 0) {
        showTablePage(1, idx);
    }
}
async function deleteHistory(idx) {
    if (!confirm("ç¡®è®¤åˆ é™¤è¯¥å†å²è®°å½•ï¼Ÿ")) return;
    await fetch(`/history/${idx}`, {method:"DELETE"});
    loadHistory();
}
function downloadHistory(idx) {
    window.open(`/history/export/${idx}`, "_blank");
}
function downloadTableCSV(index, tableIdx) {
    window.open(`/history/export_table/${index}/${tableIdx}`, "_blank");
}
document.getElementById("search").oninput = (e) => loadHistory(e.target.value.trim());
loadHistory();
</script>
</body>
</html>